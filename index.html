<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-t-title="pages.index.text.0001">Market, Business & Delivery Models Taxonomy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        #classification-panel {
            position: absolute;
            top: calc(100% + 6px);
            left: 0; right: 0;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.10);
            z-index: 200;
            overflow: hidden;
            display: none;
        }
        #classification-panel.visible { display: block; }
        .cp-header {
            padding: 10px 16px 6px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.09em;
            color: #9ca3af;
            border-bottom: 1px solid #f3f4f6;
        }
        .cp-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-bottom: 1px solid #f3f4f6;
        }
        .cp-row:last-child { border-bottom: none; }
        .cp-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            min-width: 110px;
            flex-shrink: 0;
        }
        .cp-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .cp-chip {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 20px;
            transition: opacity 0.15s;
        }
        .cp-chip:hover { opacity: 0.8; }
        .cp-chip.market  { background:#f0fdf4; color:#15803d; border:1px solid #bbf7d0; }
        .cp-chip.business { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }
        .cp-chip.delivery { background:#f5f3ff; color:#6d28d9; border:1px solid #ddd6fe; }
        .cp-chip.none { background:#f9fafb; color:#9ca3af; border:1px solid #e5e7eb; cursor:default; font-weight:400; }
        .cp-none-text { font-size: 0.75rem; color: #9ca3af; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div style="text-align:center; margin-bottom: 8px;"><span class="part-badge part-badge-a"><span class="part-badge-dot"></span>Part A — Market Structure</span></div>
            <h1 data-i18n="header.title"><span data-t="pages.index.text.0002"></span></h1>
            <p class="subtitle" data-i18n="header.subtitle"><span data-t="pages.index.text.0003"></span></p>

            <!-- Search Bar -->
            <div class="search-container">
                <p class="search-label">Search by keyword</p>
                <div class="search-row">
                    <svg class="search-icon" width="20" height="20" viewbox="0 0 20 20" fill="none">
                        <path d="M9 17A8 8 0 109 1a8 8 0 000 16zM19 19l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <input type="text" id="market-search" class="search-input" placeholder="" data-i18n="search.placeholder" data-i18n-placeholder="true" autocomplete="off" data-t-attr="placeholder:pages.index.attr.placeholder.0001">
                    <button class="search-btn" id="keyword-search-btn" type="button">Search</button>
                </div>

                <div class="flow-mode">
                    <span class="flow-label"><span data-t="pages.index.text.0005e"></span></span>
                    <button class="btn btn-small flow-btn" id="btn-step-by-step"><span data-t="pages.index.text.0005d"></span></button>
                    <button class="btn btn-small flow-btn active" id="btn-auto-complete"><span data-t="pages.index.text.0005c"></span></button>
                </div>
                <div class="search-results hidden" id="search-results">
                    <!-- Populated by JavaScript -->
                </div>
                <div id="classification-panel">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="step-panel hidden" id="step-panel">
                    <!-- Populated by step-by-step JS -->
                </div>
            </div>

            <div class="search-container prompt-container">
                <p class="search-label">Prompt (AI)</p>
                <div class="search-row prompt-row">
                    <svg class="search-icon" width="20" height="20" viewbox="0 0 20 20" fill="none">
                        <path d="M9 17A8 8 0 109 1a8 8 0 000 16zM19 19l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <input type="text" id="prompt-search" class="search-input" placeholder="Describe your idea to auto-fill with AI" autocomplete="off">
                    <button class="search-btn" id="prompt-search-btn" type="button">Go</button>
                </div>
                <div class="prompt-actions"></div>
                <p class="ai-helper-text">Uses AI to auto-complete the full flow.</p>
                <div style="margin-top: 16px; text-align: center;">
                    <a href="macro-markets.html" class="btn btn-small" style="background: var(--green); color: white; padding: 10px 24px;">Markets →</a>
                    <a href="BUSINESS DOMAINS TAXONOMY/business-domains.html" class="btn btn-small" style="background: #059669; color: white; padding: 10px 24px; margin-left: 10px;">Business Domains →</a>
                    <a href="BUSINESS SYSTEMS TAXONOMY/business.html" class="btn btn-small" style="background: #2563eb; color: white; padding: 10px 24px; margin-left: 10px;">Business Systems →</a>
                    <a href="DELIVERY MODELS TAXONOMY/delivery.html" class="btn btn-small" style="background: #7c3aed; color: white; padding: 10px 24px; margin-left: 10px;">Delivery Models →</a>
                </div>
            </div>

</header>

        <!-- Favorites Section -->
        <section class="favorites-section hidden" id="favorites-section">
            <div class="favorites-header">
                <h2 data-i18n="favorites.title"><span data-t="pages.index.text.0006"></span></h2>
                <p data-i18n="favorites.subtitle"><span data-t="pages.index.text.0007"></span></p>
            </div>
            <div class="favorites-grid" id="favorites-grid">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        

        <!-- Enhanced Footer -->
        <footer class="site-footer-enhanced">
            <div class="footer-content">
                <div class="footer-section">
                    <h4><span data-t="pages.index.text.0141"></span></h4>
                    <p><span data-t="pages.index.text.0142"></span></p>
                    <p style="margin-top:8px; font-size:0.72rem; color:var(--text-tertiary,#9ca3af);">Part A · Part B · Part C</p>
                </div>

                <div class="footer-section">
                    <h4>Taxonomy</h4>
                    <ul>
                        <li><a href="macro-markets.html">43 Markets →</a></li>
                        <li><a href="BUSINESS SYSTEMS TAXONOMY/business.html">12 Business Systems →</a></li>
                        <li><a href="DELIVERY MODELS TAXONOMY/delivery.html">12 Delivery Models →</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>Foundation</h4>
                    <ul>
                        <li><a href="BUSINESS SYSTEMS TAXONOMY/business-systems-why.html">Why 12 Business Systems</a></li>
                        <li><a href="BUSINESS SYSTEMS TAXONOMY/unit-economics-why.html">Unit Economics — Why These Numbers</a></li>
                        <li><a href="DELIVERY MODELS TAXONOMY/delivery-models-why.html">Why Delivery Models Are Universal</a></li>
                        <li><a href="global-investors.html"><span data-t="pages.index.text.0144"></span></a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4><span data-t="pages.index.text.0143"></span></h4>
                    <ul>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="https://github.com/Richardkenne/Market-taxonomy" target="_blank" rel="noopener"><span data-t="pages.index.text.0145"></span></a></li>
                        <li><a href="id/index.html"><span data-t="pages.index.text.0151"></span></a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p><span id="current-date-footer"></span> • v0.3 — Feb 2026 — Market, Business &amp; Delivery Models Taxonomy</p>
            </div>
        </footer>
        <script src="content/t.js"></script><script>
        (function () {
            var now = new Date();
            var formatted = new Intl.DateTimeFormat("en-GB", {
                year: "numeric", month: "long", day: "2-digit"
            }).format(now);
            var el = document.getElementById("current-date-footer");
            if (el) el.textContent = "Today, " + formatted + " — Richard Kennedy";
        })();
        </script>


        <!-- Progress Bar (hidden on homepage) -->
        <div class="progress-container hidden homepage-hide" id="progress-container">
            <div class="progress-steps">
                <div class="step-indicator active" data-step="0">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0153"></span></span>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="1">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0154"></span></span>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="2">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0155"></span></span>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="3">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0156"></span></span>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="4">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0157"></span></span>
                </div>
            </div>
        </div>

        <!-- Wizard Area (hidden on homepage) -->
        <main class="wizard-area homepage-hide">
            <div class="step-content" id="step-content">
                <!-- Populated by JS -->
            </div>
        </main>

        <!-- Action Buttons (hidden on homepage) -->
        <div class="actions hidden homepage-hide" id="actions">
            <button class="btn btn-secondary" id="btn-back" disabled>
                <svg width="16" height="16" viewbox="0 0 16 16" fill="none"><path d="M10 12L6 8l4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Back
            </button>
            <button class="btn btn-ghost" id="btn-reset"><span data-t="pages.index.text.0158"></span></button>
        </div>

        <!-- Summary (shown after completion, hidden on homepage) -->
        <div class="summary-area hidden homepage-hide" id="summary-area">
            <div class="summary-card">
                <h2><span data-t="pages.index.text.0159"></span></h2>
                <div class="summary-grid" id="summary-grid">
                    <!-- Populated by JS -->
                </div>
                <div class="summary-actions">
                    <button class="btn btn-primary" id="btn-add-sheet">
                        <svg width="16" height="16" viewbox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg>
                        Add to Sheet
                    </button>
                    <button class="btn btn-secondary" id="btn-new-idea"><span data-t="pages.index.text.0160"></span></button>
                </div>
            </div>
        </div>

        <!-- Sheet Section (hidden on homepage) -->
        <section class="sheet-section hidden homepage-hide" id="sheet-section">
            <div class="sheet-header">
                <h2><span data-t="pages.index.text.0161"></span></h2>
                <div class="sheet-actions">
                    <button class="btn btn-small" id="btn-export">
                        <svg width="14" height="14" viewbox="0 0 16 16" fill="none"><path d="M2 11v2a1 1 0 001 1h10a1 1 0 001-1v-2M8 2v8M5 7l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                        Export CSV
                    </button>
                    <button class="btn btn-small btn-danger" id="btn-clear-sheet"><span data-t="pages.index.text.0162"></span></button>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="ideas-table">
                    <thead>
                        <tr>
                            <th><span data-t="pages.index.text.0163"></span></th>
                            <th><span data-t="pages.index.text.0164"></span></th>
                            <th><span data-t="pages.index.text.0165"></span></th>
                            <th><span data-t="pages.index.text.0166"></span></th>
                            <th><span data-t="pages.index.text.0167"></span></th>
                            <th><span data-t="pages.index.text.0168"></span></th>
                            <th><span data-t="pages.index.text.0169"></span></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="ideas-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Sources Section (hidden on homepage) -->
        <footer class="sources-section homepage-hide" id="sources-section">
            <div class="sources-header">
                <h3><span data-t="pages.index.text.0170"></span></h3>
            </div>
            <ul class="sources-list" id="sources-list">
                <!-- Populated by JS -->
            </ul>
            <div class="add-source-row">
                <input type="text" id="source-input" placeholder="" data-t-attr="placeholder:pages.index.attr.placeholder.0045">
                <button class="btn btn-small" id="btn-add-source"><span data-t="pages.index.text.0171"></span></button>
            </div>
        </footer>
    </div>

    <script src="app.js"></script>
    <script>
        // ═══════════════════════════════════════════════════════════
        // FAVORITES FUNCTIONALITY
        // ═══════════════════════════════════════════════════════════

        const FAVORITES_KEY = 'market_taxonomy_favorites';

        // Load favorites from localStorage
        function loadFavorites() {
            const stored = localStorage.getItem(FAVORITES_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        // Save favorites to localStorage
        function saveFavorites(favorites) {
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
        }

        // Toggle favorite
        function toggleFavorite(marketId, marketName, marketHref) {
            let favorites = loadFavorites();
            const index = favorites.findIndex(f => f.id === marketId);

            if (index > -1) {
                // Remove from favorites
                favorites.splice(index, 1);
            } else {
                // Add to favorites
                favorites.push({ id: marketId, name: marketName, href: marketHref });
            }

            saveFavorites(favorites);
            renderFavorites();
            updateFavoriteButtons();
        }

        // Render favorites section
        function renderFavorites() {
            const favorites = loadFavorites();
            const favSection = document.getElementById('favorites-section');
            const favGrid = document.getElementById('favorites-grid');

            if (favorites.length === 0) {
                favSection.classList.add('hidden');
                return;
            }

            favSection.classList.remove('hidden');
            favGrid.innerHTML = '';

            favorites.forEach(fav => {
                const card = document.createElement('a');
                card.href = fav.href;
                card.className = 'market-card favorite-card';
                card.innerHTML = `
                    <button class="remove-favorite-btn" data-market-id="${fav.id}" title="Remove from favorites">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <h3>${fav.name}</h3>
                `;

                // Remove favorite handler
                const removeBtn = card.querySelector('.remove-favorite-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleFavorite(fav.id, fav.name, fav.href);
                });

                favGrid.appendChild(card);
            });
        }

        // Update favorite buttons state
        function updateFavoriteButtons() {
            const favorites = loadFavorites();
            const favoriteIds = favorites.map(f => f.id);

            document.querySelectorAll('.favorite-btn').forEach(btn => {
                const marketId = btn.dataset.marketId;
                const isFavorite = favoriteIds.includes(marketId);

                if (isFavorite) {
                    btn.classList.add('active');
                    btn.title = 'Remove from favorites';
                } else {
                    btn.classList.remove('active');
                    btn.title = 'Add to favorites';
                }
            });
        }

        // Initialize favorites
        document.addEventListener('DOMContentLoaded', () => {
            renderFavorites();
            updateFavoriteButtons();

            // Add click handlers to all favorite buttons
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const marketId = btn.dataset.marketId;
                    const card = btn.closest('.market-card');
                    const marketName = card.dataset.marketName;
                    const marketHref = card.href;

                    toggleFavorite(marketId, marketName, marketHref);
                });
            });
        });

        // ═══════════════════════════════════════════════════════════
        // BUSINESS SYSTEMS & DELIVERY MODELS INDEX
        // ═══════════════════════════════════════════════════════════
        const BUSINESS_SYSTEMS_INDEX = [
            { name: "Subscription", href: "BUSINESS SYSTEMS TAXONOMY/business.html#01", keywords: ["subscription", "recurring", "saas", "membership", "access", "netflix", "spotify", "monthly fee", "annual plan", "renewal", "subscriber"] },
            { name: "Transaction Fee", href: "BUSINESS SYSTEMS TAXONOMY/business.html#02", keywords: ["transaction", "commission", "fee", "payment", "stripe", "paypal", "marketplace fee", "product sales", "direct sales", "sell products", "selling", "sell goods", "b2b sales", "b2c sales", "manufacturing sales", "wholesale", "retail sales"] },
            { name: "Usage-Based", href: "BUSINESS SYSTEMS TAXONOMY/business.html#03", keywords: ["usage", "pay per use", "metered", "consumption", "aws", "twilio", "api calls", "per unit", "volume pricing", "pay as you go"] },
            { name: "Licensing / IP", href: "BUSINESS SYSTEMS TAXONOMY/business.html#04", keywords: ["licensing", "licence", "ip", "royalty", "intellectual property", "franchise", "brand", "hair brand", "beauty brand", "fashion brand", "brand licensing", "trademark", "patent", "white label"] },
            { name: "Marketplace", href: "BUSINESS SYSTEMS TAXONOMY/business.html#05", keywords: ["marketplace", "platform", "two-sided", "multisided", "amazon", "uber", "etsy", "network", "exchange", "connect buyers", "connect sellers"] },
            { name: "Advertising / Attention", href: "BUSINESS SYSTEMS TAXONOMY/business.html#06", keywords: ["advertising", "ads", "attention", "media", "google", "meta", "youtube", "monetize audience", "ad revenue", "sponsored", "influencer", "content monetization"] },
            { name: "Asset Ownership", href: "BUSINESS SYSTEMS TAXONOMY/business.html#07", keywords: ["asset", "ownership", "real estate", "reit", "leasing", "infrastructure", "yield", "bitcoin", "crypto", "cryptocurrency", "blockchain investor", "investor", "investment", "portfolio", "hold assets", "property", "factory", "equipment", "capital", "fund", "wealth", "net worth", "billionaire", "manufacturing assets", "vertically integrated"] },
            { name: "Service / Retainer", href: "BUSINESS SYSTEMS TAXONOMY/business.html#08", keywords: ["service", "retainer", "consulting", "agency", "professional services", "law firm", "lawyer", "legal", "attorney", "contractor", "main contractor", "engineering", "construction services", "advisory", "accountant", "audit", "management consulting", "freelance"] },
            { name: "Performance / Outcome", href: "BUSINESS SYSTEMS TAXONOMY/business.html#09", keywords: ["performance", "outcome", "results", "affiliate", "commission", "carried interest", "ipo", "going public", "success fee", "investment banking", "m&a", "acquisition", "deal fee", "fundraising fee", "exit"] },
            { name: "Data / Insight", href: "BUSINESS SYSTEMS TAXONOMY/business.html#10", keywords: ["data", "insight", "analytics", "bloomberg", "nielsen", "palantir", "data product", "research", "report", "intelligence", "market data", "information product"] },
            { name: "Platform / Ecosystem", href: "BUSINESS SYSTEMS TAXONOMY/business.html#11", keywords: ["platform", "ecosystem", "app store", "salesforce", "android", "third party", "standard", "developer platform", "infrastructure platform"] },
            { name: "Hybrid / Stack", href: "BUSINESS SYSTEMS TAXONOMY/business.html#12", keywords: ["hybrid", "stack", "combination", "mixed model", "multiple revenue", "diversified", "conglomerate", "multi-business"] },
        ];

        const DELIVERY_MODELS_INDEX = [
            { name: "SaaS / Cloud Software", href: "DELIVERY MODELS TAXONOMY/delivery.html#01", keywords: ["saas", "cloud software", "cloud", "multi-tenant", "web app", "notion", "slack", "web-based", "browser", "online platform"] },
            { name: "API-First / Embedded Digital", href: "DELIVERY MODELS TAXONOMY/delivery.html#02", keywords: ["api", "api-first", "programmatic", "integration", "stripe api", "twilio", "openai api", "developer api", "webhook", "sdk"] },
            { name: "On-Premise / Installed Software", href: "DELIVERY MODELS TAXONOMY/delivery.html#03", keywords: ["on-premise", "on-prem", "self-hosted", "local install", "enterprise software", "private cloud", "data center"] },
            { name: "Open-Core + Hosted", href: "DELIVERY MODELS TAXONOMY/delivery.html#04", keywords: ["open source", "open core", "self-hosted", "gitlab", "hashicorp", "elastic", "community edition", "open source core"] },
            { name: "Direct Physical / D2C", href: "DELIVERY MODELS TAXONOMY/delivery.html#05", keywords: ["direct to consumer", "d2c", "dtc", "ship direct", "physical product", "manufacturing", "product company", "ornament", "hair brand", "consumer brand", "physical goods", "sell direct", "ecommerce brand"] },
            { name: "Retail / In-store", href: "DELIVERY MODELS TAXONOMY/delivery.html#06", keywords: ["retail", "in-store", "physical store", "shop", "store", "point of sale", "shelf", "distribution", "supermarket", "fashion retail", "consumer goods"] },
            { name: "On-demand / Last-mile", href: "DELIVERY MODELS TAXONOMY/delivery.html#07", keywords: ["on-demand", "last-mile", "delivery", "food delivery", "courier", "same day", "logistics", "instant delivery", "quick commerce"] },
            { name: "Wholesale / B2B Distribution", href: "DELIVERY MODELS TAXONOMY/delivery.html#08", keywords: ["wholesale", "b2b distribution", "bulk", "distributor", "supply chain", "reseller", "trader", "trading", "commodity", "construction supply", "vertically integrated"] },
            { name: "In-person / On-site Service", href: "DELIVERY MODELS TAXONOMY/delivery.html#09", keywords: ["in-person", "on-site", "on site", "physical service", "contractor", "construction", "main contractor", "engineering", "law firm", "in person", "face to face", "clinic", "site visit"] },
            { name: "Remote / Virtual Service", href: "DELIVERY MODELS TAXONOMY/delivery.html#10", keywords: ["remote", "virtual", "online service", "digital service", "remote consulting", "video call", "async", "remote legal", "online advisory", "virtual assistant"] },
            { name: "Platform / Ecosystem Delivery", href: "DELIVERY MODELS TAXONOMY/delivery.html#11", keywords: ["platform delivery", "ecosystem", "app store", "extensions", "plugins", "third party dev", "marketplace extensions", "add-ons", "shopify", "aws marketplace"] },
            { name: "Hybrid / Phygital", href: "DELIVERY MODELS TAXONOMY/delivery.html#12", keywords: ["hybrid delivery", "phygital", "multi-channel", "omnichannel", "combined delivery", "web and mobile", "desktop and cloud", "online and offline"] },
        ];

        function searchExtended(query) {
            if (!query || query.length < 2) return [];
            const q = query.toLowerCase();
            const results = [];

            [...BUSINESS_SYSTEMS_INDEX].forEach(item => {
                const nameMatch = item.name.toLowerCase().includes(q);
                const kwMatch = item.keywords.some(kw => kw.includes(q));
                if (nameMatch || kwMatch) {
                    results.push({ ...item, category: 'business', matchType: 'business' });
                }
            });

            [...DELIVERY_MODELS_INDEX].forEach(item => {
                const nameMatch = item.name.toLowerCase().includes(q);
                const kwMatch = item.keywords.some(kw => kw.includes(q));
                if (nameMatch || kwMatch) {
                    results.push({ ...item, category: 'delivery', matchType: 'delivery' });
                }
            });

            return results;
        }

        // ═══════════════════════════════════════════════════════════
        // SEARCH FUNCTIONALITY
        // ═══════════════════════════════════════════════════════════

        const MARKET_HREFS = {
            "Real Estate": "MARKETS/Real Estate/L1/market-real-estate.html",
            "Construction & Infrastructure": "MARKETS/Construction & Infrastructure/L1/market-construction-infrastructure.html",
            "Food & Beverage": "MARKETS/Food & Beverage/L1/market-food-beverage.html",
            "Agriculture": "MARKETS/Agriculture/L1/market-agriculture.html",
            "Energy": "MARKETS/Energy/L1/market-energy.html",
            "Utilities": "MARKETS/Utilities/L1/market-utilities.html",
            "Transportation & Mobility": "MARKETS/Transportation & Mobility/L1/market-transportation-mobility.html",
            "Automotive": "MARKETS/Automotive/L1/market-automotive.html",
            "Manufacturing": "MARKETS/Manufacturing/L1/market-manufacturing.html",
            "Consumer Goods": "MARKETS/Consumer Goods/L1/market-consumer-goods.html",
            "Retail & E-commerce": "MARKETS/Retail & E-commerce/L1/market-retail-ecommerce.html",
            "Wholesale & Distribution": "MARKETS/Wholesale & Distribution/L1/market-wholesale-distribution.html",
            "Healthcare": "MARKETS/Healthcare/L1/market-healthcare.html",
            "Pharmaceuticals & Biotech": "MARKETS/Pharmaceuticals & Biotech/L1/market-pharmaceuticals-biotech.html",
            "Medical Devices": "MARKETS/Medical Devices/L1/market-medical-devices.html",
            "Financial Services": "MARKETS/Financial Services/L1/market-financial-services.html",
            "Banking": "MARKETS/Banking/L1/market-banking.html",
            "Insurance": "MARKETS/Insurance/L1/market-insurance.html",
            "Payments": "MARKETS/Payments/L1/market-payments.html",
            "Capital Markets": "MARKETS/Capital Markets/L1/market-capital-markets.html",
            "Technology": "MARKETS/Technology/L1/market-technology.html",
            "Software": "MARKETS/Software/L1/market-software.html",
            "Hardware": "MARKETS/Hardware/L1/market-hardware.html",
            "Telecommunications": "MARKETS/Telecommunications/L1/market-telecommunications.html",
            "Media & Entertainment": "MARKETS/Media & Entertainment/L1/market-media-entertainment.html",
            "Gaming": "MARKETS/Gaming/L1/market-gaming.html",
            "Advertising & Marketing": "MARKETS/Advertising & Marketing/L1/market-advertising-marketing.html",
            "Education": "MARKETS/Education/L1/market-education.html",
            "Professional Services": "MARKETS/Professional Services/L1/market-professional-services.html",
            "Legal": "MARKETS/Legal/L1/market-legal.html",
            "HR & Recruiting": "MARKETS/HR & Recruiting/L1/market-hr-recruiting.html",
            "Security & Defense": "MARKETS/Security & Defense/L1/market-security-defense.html",
            "Government & Public Sector": "MARKETS/Government & Public Sector/L1/market-government-public-sector.html",
            "Tourism & Hospitality": "MARKETS/Tourism & Hospitality/L1/market-tourism-hospitality.html",
            "Fashion & Apparel": "MARKETS/Fashion & Apparel/L1/market-fashion-apparel.html",
            "Logistics & Supply Chain": "MARKETS/Logistics & Supply Chain/L1/market-logistics-supply-chain.html",
            "Chemicals & Materials": "MARKETS/Chemicals & Materials/L1/market-chemicals-materials.html",
            "Mining": "MARKETS/Mining/L1/market-mining.html",
            "Aerospace": "MARKETS/Aerospace/L1/market-aerospace.html",
            "Environmental & Climate": "MARKETS/Environmental & Climate/L1/market-environmental-climate.html",
            "Non-profit & Social": "MARKETS/Non-profit & Social/L1/market-nonprofit-social.html",
            "Religion & Faith": "MARKETS/Religion & Faith/L1/market-religion-faith.html",
            "Sports & Fitness": "MARKETS/Sports & Fitness/L1/market-sports-fitness.html"
        };

        let MARKET_INDEX = [];
        let TAXONOMY_DATA = {}; // L1 → [L2] structure from taxonomy-data.json

        // ── URL helpers ──────────────────────────────────────────
        function slugify(str) {
            return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        }

        function buildUrl(marketName, l1Name, l2Name) {
            const ms = slugify(marketName);
            const base = `MARKETS/${marketName}/`;
            if (!l1Name) return MARKET_HREFS[marketName] || '#';
            if (!l2Name) return `${base}L2/market-${ms}-${slugify(l1Name)}.html`;
            return `${base}L3/market-${ms}-${slugify(l1Name)}-${slugify(l2Name)}-l3.html`;
        }

        // ── Deep match: L0 → L1 → L2 ────────────────────────────
        function matchDeep(query) {
            const tokens = query.toLowerCase().split(/\s+/).filter(Boolean).slice(0, 6);

            // Step 1: find best L0 market
            const l0Matches = getTopMatches(query, 3);
            if (!l0Matches.length) return null;
            const market = l0Matches[0];

            // Step 2: try to match L1 from taxonomy data
            const l1Options = TAXONOMY_DATA[market.name]
                ? Object.keys(TAXONOMY_DATA[market.name].l1 || {})
                : [];
            if (!l1Options.length) return { market, l1: null, l2: null, l2Candidates: [] };

            let bestL1 = null, bestL1Score = 0;
            l1Options.forEach(l1Name => {
                const l1Slug = l1Name.toLowerCase();
                let score = 0;
                tokens.forEach(t => {
                    if (l1Slug === t) score += 100;
                    else if (l1Slug.includes(t) && t.length > 2) score += 60;
                    else {
                        const re = new RegExp('(?:^|\\s)' + t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '(?:\\s|$)');
                        if (re.test(l1Slug)) score += 40;
                    }
                });
                if (score > bestL1Score) { bestL1Score = score; bestL1 = l1Name; }
            });
            if (!bestL1 || bestL1Score === 0) return { market, l1: null, l2: null, l2Candidates: [] };

            // Step 3: try to match L2 from taxonomy data
            const l2Options = (TAXONOMY_DATA[market.name]?.l1?.[bestL1]) || [];
            if (!l2Options.length) return { market, l1: bestL1, l2: null, l2Candidates: [] };

            const l2Scored = [];
            l2Options.forEach(l2Name => {
                const l2Slug = l2Name.toLowerCase();
                let score = 0;
                tokens.forEach(t => {
                    if (l2Slug === t) score += 100;
                    else if (l2Slug.includes(t) && t.length > 2) score += 60;
                    else {
                        const re = new RegExp('(?:^|\\s)' + t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '(?:\\s|$)');
                        if (re.test(l2Slug)) score += 40;
                    }
                });
                if (score > 0) l2Scored.push({ name: l2Name, score });
            });
            l2Scored.sort((a, b) => b.score - a.score);

            const topL2 = l2Scored[0];
            const secondL2 = l2Scored[1];
            const clearL2 = topL2 && (!secondL2 || (topL2.score - secondL2.score) >= 30);

            return {
                market,
                l1: bestL1,
                l2: clearL2 ? topL2.name : null,
                l2Candidates: l2Scored.slice(0, 3)
            };
        }

        function renderL2Panel(marketName, l1Name, candidates) {
            closeStepPanel();
            searchResults.classList.add('hidden');
            stepPanel.classList.remove('hidden');
            const topScore = candidates.length > 0 ? candidates[0].score : 1;
            const items = candidates.map((c, i) => {
                const pct = Math.round((c.score / topScore) * 100);
                const url = buildUrl(marketName, l1Name, c.name);
                return `<li>
                    <a class="step-panel-item" href="${url}">
                        <span class="step-item-num">${String(i + 1).padStart(2, '0')}</span>
                        <span class="step-item-name">${c.name}</span>
                        <span class="step-item-pct">${pct}%</span>
                        <svg class="step-item-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </a>
                </li>`;
            }).join('');
            stepPanel.innerHTML = `
                <div class="step-panel-header">
                    <span class="step-panel-label">Step 2 — Confirm sub-market</span>
                    <span class="step-panel-hint">${marketName} › ${l1Name}</span>
                    <button class="step-panel-close" id="step-panel-close" title="Close">
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                            <path d="M1 1l12 12M13 1L1 13" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
                <ul class="step-panel-list">${items}</ul>`;
            document.getElementById('step-panel-close').addEventListener('click', () => stepPanel.classList.add('hidden'));
        }

        fetch('content/markets-keywords.json')
            .then(r => r.json())
            .then(data => {
                MARKET_INDEX = Object.entries(data).map(([name, val]) => {
                    const keywords = Array.isArray(val) ? val : (val.keywords || []);
                    const l1Keywords = [];
                    const l1Map = {};
                    if (val && val.l1) {
                        Object.entries(val.l1).forEach(([l1Name, kws]) => {
                            l1Map[l1Name] = kws;
                            kws.forEach(kw => l1Keywords.push({ kw, l1: l1Name }));
                        });
                    }
                    return { name, keywords, l1Keywords, l1Map, href: MARKET_HREFS[name] || '#' };
                });
            })
            .catch(() => {
                MARKET_INDEX = Object.entries(MARKET_HREFS).map(([name, href]) => ({
                    name, keywords: [name.toLowerCase()], l1Keywords: [], l1Map: {}, href
                }));
            });

        fetch('content/taxonomy-data.json')
            .then(r => r.json())
            .then(data => { TAXONOMY_DATA = data; })
            .catch(() => { TAXONOMY_DATA = {}; });

        const searchInput = document.getElementById('market-search');
        const searchResults = document.getElementById('search-results');
        const btnAutoComplete = document.getElementById('btn-auto-complete');
        const btnStepByStep = document.getElementById('btn-step-by-step');
        const promptInput = document.getElementById('prompt-search');
        const AI_ENDPOINT = localStorage.getItem('ai_endpoint') || 'https://market-taxonomy-ai.richardbotsiokennedy.workers.dev';
        const AI_TIMEOUT_MS = 12000;

        function searchMarkets(query) {
            if (!query || query.length < 2) {
                return [];
            }

            const lowerQuery = query.toLowerCase();
            const matches = [];

            MARKET_INDEX.forEach(market => {
                // Check name
                if (market.name.toLowerCase().includes(lowerQuery)) {
                    matches.push({ ...market, matchType: 'name' });
                    return;
                }

                // Check L0 keywords
                const keywordMatch = market.keywords.some(kw => kw.includes(lowerQuery));
                if (keywordMatch) {
                    matches.push({ ...market, matchType: 'keyword' });
                    return;
                }

                // Check L1 keywords
                const l1Hit = (market.l1Keywords || []).find(({ kw }) => kw.includes(lowerQuery));
                if (l1Hit) {
                    matches.push({ ...market, matchType: 'l1', matchedL1: l1Hit.l1 });
                }
            });

            if (matches.length === 0) {
    const { selections } = mapQueryToSelections(query);
    const fallbackName = selections.market || 'Advertising & Marketing';
    const fallback = MARKET_INDEX.find(m => m.name === fallbackName) || MARKET_INDEX[0];
    if (fallback) {
        return [{ ...fallback, matchType: 'fallback' }];
    }
}

return matches.slice(0, 8); // Max 8 results
        }

        function getBestMarketMatch(query) {
            if (!query) return null;
            const q = query.toLowerCase().trim();
            if (!q) return null;

            let best = null;
            let bestScore = -1;
            let secondScore = -1;

            MARKET_INDEX.forEach(market => {
                const name = market.name.toLowerCase();
                let score = 0;

                if (name === q) score += 100;
                if (name.includes(q)) score += 80;
                if (market.keywords.some(kw => kw === q)) score += 90;
                if (market.keywords.some(kw => kw.includes(q))) score += 70;

                // L1 keyword match (slightly lower weight than L0 exact)
                const l1Exact = (market.l1Keywords || []).find(({ kw }) => kw === q);
                if (l1Exact) score += 85;
                else {
                    const l1Partial = (market.l1Keywords || []).find(({ kw }) => kw.includes(q));
                    if (l1Partial) score += 60;
                }

                const tokens = q.split(/\s+/).filter(Boolean);
                if (tokens.length) {
                    const tokenHits = tokens.filter(t =>
                        name.includes(t) ||
                        market.keywords.some(kw => kw.includes(t)) ||
                        (market.l1Keywords || []).some(({ kw }) => kw.includes(t))
                    ).length;
                    score += tokenHits * 10;
                }

                if (score > bestScore) {
                    secondScore = bestScore;
                    bestScore = score;
                    best = market;
                } else if (score > secondScore) {
                    secondScore = score;
                }
            });

            // If we didn't get any positive signal, treat as no match
            if (bestScore <= 0) {
                return { match: null, ambiguous: false, score: bestScore };
            }

            if (!best && q.length > 0) {
                const { selections } = mapQueryToSelections(q);
                const fallbackName = selections.market || 'Advertising & Marketing';
                best = MARKET_INDEX.find(m => m.name === fallbackName) || MARKET_INDEX[0] || null;
            }

            const ambiguous = bestScore > 0 && secondScore >= bestScore - 10;
            return { match: best, ambiguous, score: bestScore };
        }

        function routeToWizardFromQuery(query, mode = "auto", match = null) {
    const { selections, keywords, highlight } = mapQueryToSelections(query);
    if (match && match.name) {
        selections.market = match.name;
    }
    const payload = { prompt: query, selections, keywords, highlight };
    localStorage.setItem('ai_prefill', JSON.stringify(payload));
    localStorage.setItem('prefill_mode', mode);
                if (mode === 'auto') {
                    localStorage.setItem('auto_add_sheet', '1');
                } else {
                    localStorage.removeItem('auto_add_sheet');
                }
    if (selections.market) {
        localStorage.setItem('selected_market', selections.market);
    }
    window.location.href = 'index.html';
}

function setFlowMode(mode) {
    if (!btnAutoComplete || !btnStepByStep) return;
    const nextMode = mode === 'step' ? 'step' : 'auto';
    btnAutoComplete.classList.toggle('active', nextMode === 'auto');
    btnStepByStep.classList.toggle('active', nextMode === 'step');
    localStorage.setItem('flow_mode', nextMode);
}

function getFlowMode() {
    const stored = localStorage.getItem('flow_mode');
    if (stored === 'step' || stored === 'auto') return stored;
    if (btnStepByStep && btnStepByStep.classList.contains('active')) return 'step';
    return 'auto';
}

// ── Step Panel UI ────────────────────────────────────────────────
const stepPanel = document.getElementById('step-panel');

function countKeywords(query) {
    return query.trim().split(/[\s,;]+/).filter(Boolean).length;
}

function wordMatch(kw, token) {
    // Returns score: 100=exact, 70=prefix, 40=word-boundary, 0=no match
    if (kw === token) return 100;
    if (kw.startsWith(token + ' ') || kw.startsWith(token + '-')) return 70;
    const re = new RegExp('(?:^|\\s)' + token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '(?:\\s|$)');
    if (re.test(kw)) return 40;
    return 0;
}

function getTopMatches(query, max) {
    if (!query || query.length < 2) return [];
    const lowerQuery = query.toLowerCase();
    const tokens = lowerQuery.split(/\s+/).filter(Boolean).slice(0, 3);

    // Build bigrams from query (e.g. "social media" → ["social media"])
    const bigrams = [];
    for (let i = 0; i < tokens.length - 1; i++) bigrams.push(tokens[i] + ' ' + tokens[i + 1]);

    const scored = [];
    MARKET_INDEX.forEach(market => {
        let score = 0;
        const name = market.name.toLowerCase();

        // Bigram match first — high reward (prevents "social" from winning over "social media")
        bigrams.forEach(bg => {
            if (market.keywords.some(kw => kw === bg)) score += 200;
            else if (market.keywords.some(kw => kw.includes(bg))) score += 140;
            else if ((market.l1Keywords || []).some(({ kw }) => kw.includes(bg))) score += 100;
        });

        // Single token match
        tokens.forEach(t => {
            // Market name — word boundary only (no substring, avoids "Non-profit & Social" for "social media")
            if (name === t) score += 120;
            else if (name.startsWith(t + ' ') || name.endsWith(' ' + t)) score += 80;
            else {
                const nameRe = new RegExp('(?:^|[\\s&/-])' + t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '(?:[\\s&/-]|$)');
                if (nameRe.test(name)) score += 50;
            }
            // L0 keywords (word boundary only)
            market.keywords.forEach(kw => {
                const s = wordMatch(kw, t);
                if (s > 0) score += s;
            });
            // L1 keywords (slightly lower)
            (market.l1Keywords || []).forEach(({ kw }) => {
                const s = wordMatch(kw, t);
                if (s > 0) score += Math.round(s * 0.75);
            });
        });

        if (score > 0) scored.push({ ...market, score });
    });
    scored.sort((a, b) => b.score - a.score);
    return scored.slice(0, max);
}

function renderStepPanel(matches, kwCount) {
    searchResults.classList.add('hidden');
    stepPanel.classList.remove('hidden');

    const isAmbiguous = matches.length > 1;
    const labelText = kwCount === 1
        ? 'Step 1 — Choose a market'
        : 'Step 1 — Confirm your market';
    const hintText = isAmbiguous
        ? `${matches.length} best matches — pick one to continue`
        : 'Best match found — click to open Level 1';

    // Calculate match % relative to top score
    const topScore = matches.length > 0 ? matches[0].score : 1;
    const withPct = matches.map(m => ({
        ...m,
        pct: Math.round((m.score / topScore) * 100)
    }));

    stepPanel.innerHTML = `
        <div class="step-panel-header">
            <span class="step-panel-label">${labelText}</span>
            <span class="step-panel-hint">${hintText}</span>
            <button class="step-panel-close" id="step-panel-close" title="Close">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M1 1l12 12M13 1L1 13" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        ${kwCount > 3 ? '<div class="step-panel-warning">⚠ Max 3 keywords for step-by-step mode. Using first 3.</div>' : ''}
        <ul class="step-panel-list">
            ${withPct.length === 0
                ? `<li class="step-panel-no-result">No markets found — try different keywords.</li>`
                : withPct.map((m, i) => `
                    <li>
                        <a class="step-panel-item" href="${m.href}">
                            <span class="step-item-num">${String(i + 1).padStart(2, '0')}</span>
                            <span class="step-item-name">${m.name}</span>
                            <span class="step-item-pct">${m.pct}%</span>
                            <svg class="step-item-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </a>
                    </li>`).join('')}
        </ul>
    `;

    document.getElementById('step-panel-close').addEventListener('click', () => {
        stepPanel.classList.add('hidden');
    });
}

function closeStepPanel() {
    if (stepPanel) stepPanel.classList.add('hidden');
}

function runQueryWithMode(mode) {
    const query = searchInput.value.trim();
    if (!query) return;
    const finalMode = mode || getFlowMode();
    setFlowMode(finalMode);

    if (finalMode !== 'step') {
        // ── AUTO MODE ────────────────────────────────────────────
        closeStepPanel();
        const kwCount = countKeywords(query);

        if (kwCount >= 2) {
            // Try deep match L0 → L1 → L2
            const deep = matchDeep(query);
            if (deep && deep.market) {
                if (deep.l2) {
                    // L0+L1+L2 all matched → go directly to L3 (problems page)
                    window.location.href = buildUrl(deep.market.name, deep.l1, deep.l2);
                    return;
                }
                if (deep.l1 && deep.l2Candidates.length > 0) {
                    // L0+L1 matched, L2 ambiguous → show L2 panel with %
                    renderL2Panel(deep.market.name, deep.l1, deep.l2Candidates);
                    return;
                }
                if (deep.l1) {
                    // L0+L1 matched, no L2 data yet → go to L2 listing
                    window.location.href = buildUrl(deep.market.name, deep.l1, null);
                    return;
                }
                // L0 only clear match → go to L1
                const second = getTopMatches(query, 2)[1];
                const clearMatch = !second || (deep.market.score - second.score) > 20;
                if (clearMatch) {
                    window.location.href = deep.market.href;
                    return;
                }
            }
            // Ambiguous L0 → show dropdown
            renderSearchResults(getTopMatches(query, 5), query);
            return;
        }

        // 1 keyword → show dropdown
        const matches = getTopMatches(query, 5);
        if (matches.length > 0) {
            renderSearchResults(matches, query);
        } else {
            const result = getBestMarketMatch(query);
            routeToWizardFromQuery(query, finalMode, result ? result.match : null);
        }
        return;
    }

    // ── STEP MODE ────────────────────────────────────────────────
    const kwCount = countKeywords(query);
    // More keywords = tighter match: 1 kw → show max 3, 2 kw → max 2, 3 kw → navigate direct
    const maxResults = kwCount === 1 ? 3 : kwCount === 2 ? 2 : 1;
    const matches = getTopMatches(query, maxResults + 2); // fetch a few extra to check gap

    if (matches.length === 0) {
        renderStepPanel([], kwCount);
        return;
    }

    // With 3 keywords or a single clear winner → navigate directly to L1
    const top = matches[0];
    const second = matches[1];
    const clearMatch = kwCount >= 3 || !second || (top.score - second.score) >= 30;
    if (clearMatch) {
        window.location.href = top.href;
        return;
    }

    // Show panel with max 3 results
    renderStepPanel(matches.slice(0, maxResults), kwCount);
}

function renderSearchResults(matches, query) {
    closeStepPanel();

    const extendedMatches = searchExtended(query);
    const allEmpty = matches.length === 0 && extendedMatches.length === 0;

    if (allEmpty) {
        searchResults.innerHTML = '<div class="search-no-results">No results found</div>';
        searchResults.classList.remove('hidden');
        return;
    }

    searchResults.innerHTML = '';

    // Market results (max 4 to leave room for extended)
    const displayMatches = matches.slice(0, 4);
    displayMatches.forEach(match => {
        const resultItem = document.createElement('a');
        resultItem.href = match.href;
        resultItem.className = 'search-result-item';
        const badge = match.matchType === 'keyword' ? '<span class="result-badge">keyword match</span>'
                    : match.matchType === 'fallback' ? '<span class="result-badge">best guess</span>'
                    : '';
        const nameSpan = document.createElement('span');
        nameSpan.className = 'result-name';
        nameSpan.textContent = match.name;
        resultItem.appendChild(nameSpan);
        resultItem.insertAdjacentHTML('beforeend', badge);
        searchResults.appendChild(resultItem);
    });

    // Business Systems & Delivery Models results (max 3 total)
    extendedMatches.slice(0, 3).forEach(match => {
        const resultItem = document.createElement('a');
        resultItem.href = match.href;
        resultItem.className = 'search-result-item';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'result-name';
        nameSpan.textContent = match.name;

        const badgeStyle = match.category === 'business'
            ? 'background:#eff6ff;color:#2563eb;border:1px solid #bfdbfe;'
            : 'background:#f5f3ff;color:#7c3aed;border:1px solid #ddd6fe;';
        const badgeLabel = match.category === 'business' ? 'Business System' : 'Delivery Model';

        resultItem.appendChild(nameSpan);
        resultItem.insertAdjacentHTML('beforeend', `<span class="result-badge" style="${badgeStyle}padding:2px 7px;border-radius:5px;font-size:0.65rem;font-weight:700;">${badgeLabel}</span>`);
        searchResults.appendChild(resultItem);
    });

    searchResults.classList.remove('hidden');
}

const classificationPanel = document.getElementById('classification-panel');

function renderClassificationPanel(query) {
    const words = query.trim().split(/\s+/).filter(Boolean);
    if (words.length < 3) {
        classificationPanel.classList.remove('visible');
        return;
    }

    const marketMatches = getTopMatches(query, 3);
    const extended = searchExtended(query);
    const businessMatches = extended.filter(m => m.category === 'business').slice(0, 3);
    const deliveryMatches = extended.filter(m => m.category === 'delivery').slice(0, 3);

    const renderChips = (items, cls) => items.length
        ? items.map(m => `<a href="${m.href}" class="cp-chip ${cls}">${m.name}</a>`).join('')
        : `<span class="cp-none-text">—</span>`;

    classificationPanel.innerHTML = `
        <div class="cp-header">Classification</div>
        <div class="cp-row">
            <span class="cp-label">Market</span>
            <div class="cp-chips">${renderChips(marketMatches, 'market')}</div>
        </div>
        <div class="cp-row">
            <span class="cp-label">Business System</span>
            <div class="cp-chips">${renderChips(businessMatches, 'business')}</div>
        </div>
        <div class="cp-row">
            <span class="cp-label">Delivery Model</span>
            <div class="cp-chips">${renderChips(deliveryMatches, 'delivery')}</div>
        </div>
    `;
    classificationPanel.classList.add('visible');
    searchResults.classList.add('hidden');
}

searchInput.addEventListener('input', (e) => {
    const query = e.target.value;
    if (!query || query.length < 2) {
        searchResults.classList.add('hidden');
        classificationPanel.classList.remove('visible');
        return;
    }

    // Long description → show classification panel
    if (query.trim().split(/\s+/).length >= 3) {
        renderClassificationPanel(query);
        return;
    }
    if (getFlowMode() === 'auto') {
        const matches = searchMarkets(query);
        renderSearchResults(matches, query);
    } else {
        // Step mode: show top 3 with % while typing
        const matches = getTopMatches(query, 3);
        if (matches.length === 0) { searchResults.classList.add('hidden'); return; }
        const topScore = matches[0].score;
        searchResults.innerHTML = '';
        matches.forEach(match => {
            const pct = Math.round((match.score / topScore) * 100);
            const item = document.createElement('a');
            item.href = match.href;
            item.className = 'search-result-item';
            const nameSpan = document.createElement('span');
            nameSpan.className = 'result-name';
            nameSpan.textContent = match.name;
            const pctSpan = document.createElement('span');
            pctSpan.className = 'step-item-pct';
            pctSpan.textContent = pct + '%';
            item.appendChild(nameSpan);
            item.appendChild(pctSpan);
            searchResults.appendChild(item);
        });
        searchResults.classList.remove('hidden');
    }
});

        if (btnAutoComplete && btnStepByStep) {
    btnAutoComplete.addEventListener('click', () => setFlowMode('auto'));
    btnStepByStep.addEventListener('click', () => setFlowMode('step'));
    setFlowMode(getFlowMode());
}

searchInput.addEventListener('focus', (e) => {
    const query = e.target.value;
    if (query.length >= 2 && getFlowMode() === 'auto') {
        const matches = searchMarkets(query);
        renderSearchResults(matches, query);
    }
});

        searchInput.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            e.preventDefault();
            runQueryWithMode();
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.add('hidden');
                classificationPanel.classList.remove('visible');
                closeStepPanel();
            }
        });

        // ── AI Suggestions (mock-friendly, toggleable) ─────────
        function mapQueryToSelections(query) {
            const lower = query.toLowerCase();
            const keywords = [];
            const selections = {};

            // Market guess
            if (lower.includes('online') || lower.includes('ecommerce') || lower.includes('store')) {
                selections.market = 'Retail & E-commerce';
                keywords.push('online');
            } else if (lower.includes('youtube')) {
                selections.market = 'Media & Entertainment';
                keywords.push('youtube');
            } else if (lower.includes('saas')) {
                selections.market = 'Software';
                keywords.push('saas');
            }

            // Mechanics
            selections.mechanics = {
                'Distribution Channels': [],
                'Monetization Models': [],
                'Business Assets': [],
                'Operating Models': []
            };
            if (lower.includes('youtube')) selections.mechanics['Distribution Channels'].push('YouTube');
            if (lower.includes('email')) selections.mechanics['Distribution Channels'].push('Email');
            if (lower.includes('seo') || lower.includes('online')) selections.mechanics['Distribution Channels'].push('SEO');
            if (lower.includes('ads') || lower.includes('paid')) selections.mechanics['Distribution Channels'].push('Paid Ads');
            if (lower.includes('affiliate')) selections.mechanics['Monetization Models'].push('Affiliate');
            if (lower.includes('subscription') || lower.includes('saas')) selections.mechanics['Monetization Models'].push('Subscription');
            if (lower.includes('data')) selections.mechanics['Business Assets'].push('Data');
            if (lower.includes('community')) selections.mechanics['Business Assets'].push('Community');
            if (lower.includes('solo') || lower.includes('creator')) selections.mechanics['Operating Models'].push('Solo Creator');
            if (lower.includes('agency')) selections.mechanics['Operating Models'].push('Agency');
            if (lower.includes('marketplace')) selections.mechanics['Operating Models'].push('Marketplace');

            // Target / Problem / Model / GTM defaults
            selections.target = lower.includes('enterprise') ? 'Enterprise' : (lower.includes('sm') ? 'SMBs' : 'Consumers (Millennials)');
            selections.problem = lower.includes('expensive') ? 'Too expensive' : 'Access / availability';
            selections.severity = lower.includes('critical') ? 'Critical — Blocks operations' : 'High — Significant daily pain';
            selections.existing_behavior = lower.includes('manual') ? 'Manually (paper, Excel, WhatsApp)' : 'With improvised tools';
            selections.model = selections.mechanics['Monetization Models'][0] || 'Subscription (SaaS)';
            selections.gtm = lower.includes('youtube') ? 'Influencer / Creator' : 'Content Marketing / SEO';
            selections.validation_signal = '🟡 Medium signal';

            const highlight = [];
            if (keywords.includes('online')) highlight.push('market');
            if (keywords.includes('youtube')) highlight.push('mechanics');

            if (!selections.market) {
    selections.market = 'Advertising & Marketing';
    if (!keywords.includes('marketing')) keywords.push('marketing');
}
return { selections, keywords, highlight };
        }

        function handleAiGenerate(queryOverride) {
            const mode = localStorage.getItem('prefill_mode') || getFlowMode();
            const query = (queryOverride ?? searchInput.value).trim();
            if (!query) {
                alert('Scrivi una frase da interpretare');
                return;
            }

            const markets = MARKET_INDEX.map(m => m.name);
            const options = {
                markets,
                mechanics: {
                    "Distribution Channels": ["YouTube", "Email", "SEO", "Paid Ads", "Influencer Marketing", "Communities"],
                    "Monetization Models": ["Subscription", "Advertising", "Lead Generation", "Affiliate", "One-off Payments"],
                    "Business Assets": ["Audience", "Data", "Software", "Community", "Brand"],
                    "Operating Models": ["Solo Creator", "Agency", "SaaS", "Marketplace", "Media Business"]
                },
                targets: ["SMBs", "Enterprise", "Startups", "Freelancers / Solopreneurs", "Consumers (Gen Z)", "Consumers (Millennials)", "Consumers (Gen X+)", "Developers", "Creators / Influencers", "Students"],
                severities: ["Critical — Blocks operations", "High — Significant daily pain", "Medium — Noticeable friction", "Low — Minor inconvenience"],
                behaviors: ["Manually (paper, Excel, WhatsApp)", "With improvised tools", "With an existing product", "Not solved at all", "Outsourced to people"],
                models: ["Subscription (SaaS)", "Marketplace", "Freemium", "Pay-per-use", "Advertising", "Licensing", "Hardware + Software", "Agency / Services"],
                gtms: ["Product-Led Growth", "Content Marketing / SEO", "Outbound Sales", "Partnerships / Channels", "Community-Led", "Paid Acquisition", "Influencer / Creator", "Events / Conferences"]
            };

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), AI_TIMEOUT_MS);

            fetch(AI_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: query, options }),
                signal: controller.signal
            })
            .then(res => {
                if (!res.ok) throw new Error("AI endpoint error");
                return res.json();
            })
            .then(data => {
                clearTimeout(timeout);
                const selections = {
                    market: data.market,
                    problem: data.problem,
                    target: data.target,
                    severity: data.severity,
                    existing_behavior: data.existing_behavior,
                    mechanics: data.mechanics,
                    model: data.model,
                    gtm: data.gtm,
                    validation_signal: "🟡 Medium signal"
                };
                const payload = {
                    prompt: query,
                    selections,
                    keywords: data.keywords || [],
                    highlight: data.highlight || []
                };

                localStorage.setItem('ai_prefill', JSON.stringify(payload));
                localStorage.setItem('prefill_mode', mode);
                if (mode === 'auto') {
                    localStorage.setItem('auto_add_sheet', '1');
                } else {
                    localStorage.removeItem('auto_add_sheet');
                }
                if (selections.market) {
                    localStorage.setItem('selected_market', selections.market);
                }
                window.location.href = 'index.html';
            })
            .catch(() => {
                clearTimeout(timeout);
                const { selections, keywords, highlight } = mapQueryToSelections(query);
                const payload = { prompt: query, selections, keywords, highlight };
                localStorage.setItem('ai_prefill', JSON.stringify(payload));
                localStorage.setItem('prefill_mode', mode);
                if (mode === 'auto') {
                    localStorage.setItem('auto_add_sheet', '1');
                } else {
                    localStorage.removeItem('auto_add_sheet');
                }
                if (selections.market) {
                    localStorage.setItem('selected_market', selections.market);
                }
                alert('AI non disponibile. Uso mapping locale.');
                window.location.href = 'index.html';
            });
        }

        if (promptInput) {
            promptInput.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                const mode = getFlowMode();
                localStorage.setItem('prefill_mode', mode);
                handleAiGenerate(promptInput.value);
            });
        }

        const keywordSearchBtn = document.getElementById('keyword-search-btn');
        if (keywordSearchBtn) {
            keywordSearchBtn.addEventListener('click', () => {
                runQueryWithMode();
            });
        }

        const promptSearchBtn = document.getElementById('prompt-search-btn');
        if (promptSearchBtn) {
            promptSearchBtn.addEventListener('click', () => {
                const mode = getFlowMode();
                localStorage.setItem('prefill_mode', mode);
                handleAiGenerate(promptInput ? promptInput.value : '');
            });
        }
    </script>
    <script src="i18n.js"></script>
</body>
</html>
