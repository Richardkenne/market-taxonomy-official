<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-t-title="pages.index.text.0001">Market Taxonomy - Pick Your Market</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div style="text-align:center; margin-bottom: 8px;"><span class="part-badge part-badge-a"><span class="part-badge-dot"></span>Part A â€” Market Structure</span></div>
            <h1 data-i18n="header.title"><span data-t="pages.index.text.0002"></span></h1>
            <p class="subtitle" data-i18n="header.subtitle"><span data-t="pages.index.text.0003"></span></p>

            <!-- Search Bar -->
            <div class="search-container">
                <p class="search-label">Search by keyword</p>
                <div class="search-row">
                    <svg class="search-icon" width="20" height="20" viewbox="0 0 20 20" fill="none">
                        <path d="M9 17A8 8 0 109 1a8 8 0 000 16zM19 19l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <input type="text" id="market-search" class="search-input" placeholder="" data-i18n="search.placeholder" data-i18n-placeholder="true" autocomplete="off" data-t-attr="placeholder:pages.index.attr.placeholder.0001">
                    <button class="search-btn" id="keyword-search-btn" type="button">Search</button>
                </div>

                <div class="flow-mode">
                    <span class="flow-label"><span data-t="pages.index.text.0005e"></span></span>
                    <button class="btn btn-small flow-btn" id="btn-step-by-step"><span data-t="pages.index.text.0005d"></span></button>
                    <button class="btn btn-small flow-btn active" id="btn-auto-complete"><span data-t="pages.index.text.0005c"></span></button>
                </div>
                <div class="search-results hidden" id="search-results">
                    <!-- Populated by JavaScript -->
                </div>
                <div class="step-panel hidden" id="step-panel">
                    <!-- Populated by step-by-step JS -->
                </div>
            </div>

            <div class="search-container prompt-container">
                <p class="search-label">Prompt (AI)</p>
                <div class="search-row prompt-row">
                    <svg class="search-icon" width="20" height="20" viewbox="0 0 20 20" fill="none">
                        <path d="M9 17A8 8 0 109 1a8 8 0 000 16zM19 19l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <input type="text" id="prompt-search" class="search-input" placeholder="Describe your idea to auto-fill with AI" autocomplete="off">
                    <button class="search-btn" id="prompt-search-btn" type="button">Go</button>
                </div>
                <div class="prompt-actions"></div>
                <p class="ai-helper-text">Uses AI to auto-complete the full flow.</p>
                <div style="margin-top: 16px; text-align: center;">
                    <a href="macro-markets.html" class="btn btn-small" style="background: var(--green); color: white; padding: 10px 24px;">Explore 43 Markets â†’</a>
                </div>
            </div>

</header>

        <!-- Favorites Section -->
        <section class="favorites-section hidden" id="favorites-section">
            <div class="favorites-header">
                <h2 data-i18n="favorites.title"><span data-t="pages.index.text.0006"></span></h2>
                <p data-i18n="favorites.subtitle"><span data-t="pages.index.text.0007"></span></p>
            </div>
            <div class="favorites-grid" id="favorites-grid">
                <!-- Populated by JavaScript -->
            </div>
        </section>

        

        <!-- Enhanced Footer -->
        <footer class="site-footer-enhanced">
            <div class="footer-content">
                <div class="footer-section">
                    <h4><span data-t="pages.index.text.0141"></span></h4>
                    <p><span data-t="pages.index.text.0142"></span></p>
                </div>
                <div class="footer-section">
                    <h4><span data-t="pages.index.text.0143"></span></h4>
                    <ul>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="global-investors.html"><span data-t="pages.index.text.0144"></span></a></li>
                        <li><a href="https://github.com/Richardkenne/Market-taxonomy" target="_blank" rel="noopener"><span data-t="pages.index.text.0145"></span></a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4><span data-t="pages.index.text.0146"></span></h4>
                    <ul>
                        <li><span data-t="pages.index.text.0147"></span></li>
                        <li><span data-t="pages.index.text.0148"></span></li>
                        <li><span data-t="pages.index.text.0149"></span></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4><span data-t="pages.index.text.0150"></span></h4>
                    <ul>
                        <li><a href="id/index.html"><span data-t="pages.index.text.0151"></span></a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p><span id="current-date-footer"></span><span data-t="pages.index.text.0152"></span></p>
            </div>
        </footer>
        <script src="content/t.js"></script><script>
        (function () {
            var now = new Date();
            var formatted = new Intl.DateTimeFormat("en-GB", {
                year: "numeric", month: "long", day: "2-digit"
            }).format(now);
            var el = document.getElementById("current-date-footer");
            if (el) el.textContent = "Today, " + formatted + " â€” Richard Kennedy";
        })();
        </script>


        <!-- Progress Bar (hidden on homepage) -->
        <div class="progress-container hidden homepage-hide" id="progress-container">
            <div class="progress-steps">
                <div class="step-indicator active" data-step="0">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0153"></span></span>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="1">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0154"></span></span>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="2">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0155"></span></span>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="3">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0156"></span></span>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="4">
                    <div class="step-dot"></div>
                    <span><span data-t="pages.index.text.0157"></span></span>
                </div>
            </div>
        </div>

        <!-- Wizard Area (hidden on homepage) -->
        <main class="wizard-area homepage-hide">
            <div class="step-content" id="step-content">
                <!-- Populated by JS -->
            </div>
        </main>

        <!-- Action Buttons (hidden on homepage) -->
        <div class="actions hidden homepage-hide" id="actions">
            <button class="btn btn-secondary" id="btn-back" disabled>
                <svg width="16" height="16" viewbox="0 0 16 16" fill="none"><path d="M10 12L6 8l4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Back
            </button>
            <button class="btn btn-ghost" id="btn-reset"><span data-t="pages.index.text.0158"></span></button>
        </div>

        <!-- Summary (shown after completion, hidden on homepage) -->
        <div class="summary-area hidden homepage-hide" id="summary-area">
            <div class="summary-card">
                <h2><span data-t="pages.index.text.0159"></span></h2>
                <div class="summary-grid" id="summary-grid">
                    <!-- Populated by JS -->
                </div>
                <div class="summary-actions">
                    <button class="btn btn-primary" id="btn-add-sheet">
                        <svg width="16" height="16" viewbox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg>
                        Add to Sheet
                    </button>
                    <button class="btn btn-secondary" id="btn-new-idea"><span data-t="pages.index.text.0160"></span></button>
                </div>
            </div>
        </div>

        <!-- Sheet Section (hidden on homepage) -->
        <section class="sheet-section hidden homepage-hide" id="sheet-section">
            <div class="sheet-header">
                <h2><span data-t="pages.index.text.0161"></span></h2>
                <div class="sheet-actions">
                    <button class="btn btn-small" id="btn-export">
                        <svg width="14" height="14" viewbox="0 0 16 16" fill="none"><path d="M2 11v2a1 1 0 001 1h10a1 1 0 001-1v-2M8 2v8M5 7l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                        Export CSV
                    </button>
                    <button class="btn btn-small btn-danger" id="btn-clear-sheet"><span data-t="pages.index.text.0162"></span></button>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="ideas-table">
                    <thead>
                        <tr>
                            <th><span data-t="pages.index.text.0163"></span></th>
                            <th><span data-t="pages.index.text.0164"></span></th>
                            <th><span data-t="pages.index.text.0165"></span></th>
                            <th><span data-t="pages.index.text.0166"></span></th>
                            <th><span data-t="pages.index.text.0167"></span></th>
                            <th><span data-t="pages.index.text.0168"></span></th>
                            <th><span data-t="pages.index.text.0169"></span></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="ideas-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Sources Section (hidden on homepage) -->
        <footer class="sources-section homepage-hide" id="sources-section">
            <div class="sources-header">
                <h3><span data-t="pages.index.text.0170"></span></h3>
            </div>
            <ul class="sources-list" id="sources-list">
                <!-- Populated by JS -->
            </ul>
            <div class="add-source-row">
                <input type="text" id="source-input" placeholder="" data-t-attr="placeholder:pages.index.attr.placeholder.0045">
                <button class="btn btn-small" id="btn-add-source"><span data-t="pages.index.text.0171"></span></button>
            </div>
        </footer>
    </div>

    <script src="app.js"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FAVORITES FUNCTIONALITY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const FAVORITES_KEY = 'market_taxonomy_favorites';

        // Load favorites from localStorage
        function loadFavorites() {
            const stored = localStorage.getItem(FAVORITES_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        // Save favorites to localStorage
        function saveFavorites(favorites) {
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
        }

        // Toggle favorite
        function toggleFavorite(marketId, marketName, marketHref) {
            let favorites = loadFavorites();
            const index = favorites.findIndex(f => f.id === marketId);

            if (index > -1) {
                // Remove from favorites
                favorites.splice(index, 1);
            } else {
                // Add to favorites
                favorites.push({ id: marketId, name: marketName, href: marketHref });
            }

            saveFavorites(favorites);
            renderFavorites();
            updateFavoriteButtons();
        }

        // Render favorites section
        function renderFavorites() {
            const favorites = loadFavorites();
            const favSection = document.getElementById('favorites-section');
            const favGrid = document.getElementById('favorites-grid');

            if (favorites.length === 0) {
                favSection.classList.add('hidden');
                return;
            }

            favSection.classList.remove('hidden');
            favGrid.innerHTML = '';

            favorites.forEach(fav => {
                const card = document.createElement('a');
                card.href = fav.href;
                card.className = 'market-card favorite-card';
                card.innerHTML = `
                    <button class="remove-favorite-btn" data-market-id="${fav.id}" title="Remove from favorites">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <h3>${fav.name}</h3>
                `;

                // Remove favorite handler
                const removeBtn = card.querySelector('.remove-favorite-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleFavorite(fav.id, fav.name, fav.href);
                });

                favGrid.appendChild(card);
            });
        }

        // Update favorite buttons state
        function updateFavoriteButtons() {
            const favorites = loadFavorites();
            const favoriteIds = favorites.map(f => f.id);

            document.querySelectorAll('.favorite-btn').forEach(btn => {
                const marketId = btn.dataset.marketId;
                const isFavorite = favoriteIds.includes(marketId);

                if (isFavorite) {
                    btn.classList.add('active');
                    btn.title = 'Remove from favorites';
                } else {
                    btn.classList.remove('active');
                    btn.title = 'Add to favorites';
                }
            });
        }

        // Initialize favorites
        document.addEventListener('DOMContentLoaded', () => {
            renderFavorites();
            updateFavoriteButtons();

            // Add click handlers to all favorite buttons
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const marketId = btn.dataset.marketId;
                    const card = btn.closest('.market-card');
                    const marketName = card.dataset.marketName;
                    const marketHref = card.href;

                    toggleFavorite(marketId, marketName, marketHref);
                });
            });
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SEARCH FUNCTIONALITY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const MARKET_HREFS = {
            "Real Estate": "MARKETS/Real Estate/L1/market-real-estate.html",
            "Construction & Infrastructure": "MARKETS/Construction & Infrastructure/L1/market-construction-infrastructure.html",
            "Food & Beverage": "MARKETS/Food & Beverage/L1/market-food-beverage.html",
            "Agriculture": "MARKETS/Agriculture/L1/market-agriculture.html",
            "Energy": "MARKETS/Energy/L1/market-energy.html",
            "Utilities": "MARKETS/Utilities/L1/market-utilities.html",
            "Transportation & Mobility": "MARKETS/Transportation & Mobility/L1/market-transportation-mobility.html",
            "Automotive": "MARKETS/Automotive/L1/market-automotive.html",
            "Manufacturing": "MARKETS/Manufacturing/L1/market-manufacturing.html",
            "Consumer Goods": "MARKETS/Consumer Goods/L1/market-consumer-goods.html",
            "Retail & E-commerce": "MARKETS/Retail & E-commerce/L1/market-retail-ecommerce.html",
            "Wholesale & Distribution": "MARKETS/Wholesale & Distribution/L1/market-wholesale-distribution.html",
            "Healthcare": "MARKETS/Healthcare/L1/market-healthcare.html",
            "Pharmaceuticals & Biotech": "MARKETS/Pharmaceuticals & Biotech/L1/market-pharmaceuticals-biotech.html",
            "Medical Devices": "MARKETS/Medical Devices/L1/market-medical-devices.html",
            "Financial Services": "MARKETS/Financial Services/L1/market-financial-services.html",
            "Banking": "MARKETS/Banking/L1/market-banking.html",
            "Insurance": "MARKETS/Insurance/L1/market-insurance.html",
            "Payments": "MARKETS/Payments/L1/market-payments.html",
            "Capital Markets": "MARKETS/Capital Markets/L1/market-capital-markets.html",
            "Technology": "MARKETS/Technology/L1/market-technology.html",
            "Software": "MARKETS/Software/L1/market-software.html",
            "Hardware": "MARKETS/Hardware/L1/market-hardware.html",
            "Telecommunications": "MARKETS/Telecommunications/L1/market-telecommunications.html",
            "Media & Entertainment": "MARKETS/Media & Entertainment/L1/market-media-entertainment.html",
            "Gaming": "MARKETS/Gaming/L1/market-gaming.html",
            "Advertising & Marketing": "MARKETS/Advertising & Marketing/L1/market-advertising-marketing.html",
            "Education": "MARKETS/Education/L1/market-education.html",
            "Professional Services": "MARKETS/Professional Services/L1/market-professional-services.html",
            "Legal": "MARKETS/Legal/L1/market-legal.html",
            "HR & Recruiting": "MARKETS/HR & Recruiting/L1/market-hr-recruiting.html",
            "Security & Defense": "MARKETS/Security & Defense/L1/market-security-defense.html",
            "Government & Public Sector": "MARKETS/Government & Public Sector/L1/market-government-public-sector.html",
            "Tourism & Hospitality": "MARKETS/Tourism & Hospitality/L1/market-tourism-hospitality.html",
            "Fashion & Apparel": "MARKETS/Fashion & Apparel/L1/market-fashion-apparel.html",
            "Logistics & Supply Chain": "MARKETS/Logistics & Supply Chain/L1/market-logistics-supply-chain.html",
            "Chemicals & Materials": "MARKETS/Chemicals & Materials/L1/market-chemicals-materials.html",
            "Mining": "MARKETS/Mining/L1/market-mining.html",
            "Aerospace": "MARKETS/Aerospace/L1/market-aerospace.html",
            "Environmental & Climate": "MARKETS/Environmental & Climate/L1/market-environmental-climate.html",
            "Non-profit & Social": "MARKETS/Non-profit & Social/L1/market-nonprofit-social.html",
            "Religion & Faith": "MARKETS/Religion & Faith/L1/market-religion-faith.html",
            "Sports & Fitness": "MARKETS/Sports & Fitness/L1/market-sports-fitness.html"
        };

        let MARKET_INDEX = [];

        fetch('content/markets-keywords.json')
            .then(r => r.json())
            .then(data => {
                MARKET_INDEX = Object.entries(data).map(([name, val]) => {
                    // Support both old format (array) and new format ({keywords, l1})
                    const keywords = Array.isArray(val) ? val : (val.keywords || []);
                    // Build flat l1Keywords list: all keywords from all L1 sub-markets
                    const l1Keywords = [];
                    const l1Map = {}; // l1Name -> [keywords]
                    if (val && val.l1) {
                        Object.entries(val.l1).forEach(([l1Name, kws]) => {
                            l1Map[l1Name] = kws;
                            kws.forEach(kw => l1Keywords.push({ kw, l1: l1Name }));
                        });
                    }
                    return { name, keywords, l1Keywords, l1Map, href: MARKET_HREFS[name] || '#' };
                });
            })
            .catch(() => {
                // Fallback minimale se il JSON non Ã¨ disponibile
                MARKET_INDEX = Object.entries(MARKET_HREFS).map(([name, href]) => ({
                    name, keywords: [name.toLowerCase()], l1Keywords: [], l1Map: {}, href
                }));
            });

        const searchInput = document.getElementById('market-search');
        const searchResults = document.getElementById('search-results');
        const btnAutoComplete = document.getElementById('btn-auto-complete');
        const btnStepByStep = document.getElementById('btn-step-by-step');
        const promptInput = document.getElementById('prompt-search');
        const AI_ENDPOINT = localStorage.getItem('ai_endpoint') || 'https://market-taxonomy-ai.richardbotsiokennedy.workers.dev';
        const AI_TIMEOUT_MS = 12000;

        function searchMarkets(query) {
            if (!query || query.length < 2) {
                return [];
            }

            const lowerQuery = query.toLowerCase();
            const matches = [];

            MARKET_INDEX.forEach(market => {
                // Check name
                if (market.name.toLowerCase().includes(lowerQuery)) {
                    matches.push({ ...market, matchType: 'name' });
                    return;
                }

                // Check L0 keywords
                const keywordMatch = market.keywords.some(kw => kw.includes(lowerQuery));
                if (keywordMatch) {
                    matches.push({ ...market, matchType: 'keyword' });
                    return;
                }

                // Check L1 keywords
                const l1Hit = (market.l1Keywords || []).find(({ kw }) => kw.includes(lowerQuery));
                if (l1Hit) {
                    matches.push({ ...market, matchType: 'l1', matchedL1: l1Hit.l1 });
                }
            });

            if (matches.length === 0) {
    const { selections } = mapQueryToSelections(query);
    const fallbackName = selections.market || 'Advertising & Marketing';
    const fallback = MARKET_INDEX.find(m => m.name === fallbackName) || MARKET_INDEX[0];
    if (fallback) {
        return [{ ...fallback, matchType: 'fallback' }];
    }
}

return matches.slice(0, 8); // Max 8 results
        }

        function getBestMarketMatch(query) {
            if (!query) return null;
            const q = query.toLowerCase().trim();
            if (!q) return null;

            let best = null;
            let bestScore = -1;
            let secondScore = -1;

            MARKET_INDEX.forEach(market => {
                const name = market.name.toLowerCase();
                let score = 0;

                if (name === q) score += 100;
                if (name.includes(q)) score += 80;
                if (market.keywords.some(kw => kw === q)) score += 90;
                if (market.keywords.some(kw => kw.includes(q))) score += 70;

                // L1 keyword match (slightly lower weight than L0 exact)
                const l1Exact = (market.l1Keywords || []).find(({ kw }) => kw === q);
                if (l1Exact) score += 85;
                else {
                    const l1Partial = (market.l1Keywords || []).find(({ kw }) => kw.includes(q));
                    if (l1Partial) score += 60;
                }

                const tokens = q.split(/\s+/).filter(Boolean);
                if (tokens.length) {
                    const tokenHits = tokens.filter(t =>
                        name.includes(t) ||
                        market.keywords.some(kw => kw.includes(t)) ||
                        (market.l1Keywords || []).some(({ kw }) => kw.includes(t))
                    ).length;
                    score += tokenHits * 10;
                }

                if (score > bestScore) {
                    secondScore = bestScore;
                    bestScore = score;
                    best = market;
                } else if (score > secondScore) {
                    secondScore = score;
                }
            });

            // If we didn't get any positive signal, treat as no match
            if (bestScore <= 0) {
                return { match: null, ambiguous: false, score: bestScore };
            }

            if (!best && q.length > 0) {
                const { selections } = mapQueryToSelections(q);
                const fallbackName = selections.market || 'Advertising & Marketing';
                best = MARKET_INDEX.find(m => m.name === fallbackName) || MARKET_INDEX[0] || null;
            }

            const ambiguous = bestScore > 0 && secondScore >= bestScore - 10;
            return { match: best, ambiguous, score: bestScore };
        }

        function routeToWizardFromQuery(query, mode = "auto", match = null) {
    const { selections, keywords, highlight } = mapQueryToSelections(query);
    if (match && match.name) {
        selections.market = match.name;
    }
    const payload = { prompt: query, selections, keywords, highlight };
    localStorage.setItem('ai_prefill', JSON.stringify(payload));
    localStorage.setItem('prefill_mode', mode);
                if (mode === 'auto') {
                    localStorage.setItem('auto_add_sheet', '1');
                } else {
                    localStorage.removeItem('auto_add_sheet');
                }
    if (selections.market) {
        localStorage.setItem('selected_market', selections.market);
    }
    window.location.href = 'index.html';
}

function setFlowMode(mode) {
    if (!btnAutoComplete || !btnStepByStep) return;
    const nextMode = mode === 'step' ? 'step' : 'auto';
    btnAutoComplete.classList.toggle('active', nextMode === 'auto');
    btnStepByStep.classList.toggle('active', nextMode === 'step');
    localStorage.setItem('flow_mode', nextMode);
}

function getFlowMode() {
    const stored = localStorage.getItem('flow_mode');
    if (stored === 'step' || stored === 'auto') return stored;
    if (btnStepByStep && btnStepByStep.classList.contains('active')) return 'step';
    return 'auto';
}

// â”€â”€ Step Panel UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const stepPanel = document.getElementById('step-panel');

function countKeywords(query) {
    return query.trim().split(/[\s,;]+/).filter(Boolean).length;
}

function getTopMatches(query, max) {
    if (!query || query.length < 2) return [];
    const lowerQuery = query.toLowerCase();
    const scored = [];
    MARKET_INDEX.forEach(market => {
        let score = 0;
        const name = market.name.toLowerCase();
        const tokens = lowerQuery.split(/\s+/).filter(Boolean);
        tokens.forEach(t => {
            if (name === t) score += 100;
            else if (name.includes(t)) score += 60;
            // L0 keywords
            if (market.keywords.some(kw => kw === t)) score += 90;
            else if (market.keywords.some(kw => kw.includes(t))) score += 50;
            // L1 keywords (slightly lower weight)
            const l1e = (market.l1Keywords || []).find(({ kw }) => kw === t);
            if (l1e) score += 80;
            else {
                const l1p = (market.l1Keywords || []).find(({ kw }) => kw.includes(t));
                if (l1p) score += 40;
            }
        });
        if (score > 0) scored.push({ ...market, score });
    });
    scored.sort((a, b) => b.score - a.score);
    return scored.slice(0, max);
}

function renderStepPanel(matches, kwCount) {
    searchResults.classList.add('hidden');
    stepPanel.classList.remove('hidden');

    const isAmbiguous = matches.length > 1;
    const labelText = kwCount === 1
        ? 'Step 1 â€” Choose a market'
        : 'Step 1 â€” Confirm your market';
    const hintText = isAmbiguous
        ? `${matches.length} markets match â€” pick one to continue`
        : 'Best match found â€” click to open Level 1';

    stepPanel.innerHTML = `
        <div class="step-panel-header">
            <span class="step-panel-label">${labelText}</span>
            <span class="step-panel-hint">${hintText}</span>
            <button class="step-panel-close" id="step-panel-close" title="Close">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M1 1l12 12M13 1L1 13" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        ${kwCount > 3 ? '<div class="step-panel-warning">âš  Max 3 keywords for step-by-step mode. Using first 3.</div>' : ''}
        <ul class="step-panel-list">
            ${matches.length === 0
                ? `<li class="step-panel-no-result">No markets found â€” try different keywords.</li>`
                : matches.map((m, i) => `
                    <li>
                        <a class="step-panel-item" href="${m.href}">
                            <span class="step-item-num">${String(i + 1).padStart(2, '0')}</span>
                            <span class="step-item-name">${m.name}</span>
                            <svg class="step-item-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </a>
                    </li>`).join('')}
        </ul>
    `;

    document.getElementById('step-panel-close').addEventListener('click', () => {
        stepPanel.classList.add('hidden');
    });
}

function closeStepPanel() {
    if (stepPanel) stepPanel.classList.add('hidden');
}

function runQueryWithMode(mode) {
    const query = searchInput.value.trim();
    if (!query) return;
    const finalMode = mode || getFlowMode();
    setFlowMode(finalMode);

    if (finalMode !== 'step') {
        // â”€â”€ AUTO MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        closeStepPanel();
        const kwCount = countKeywords(query);
        const matches = getTopMatches(query, 8);

        if (kwCount >= 2 && matches.length > 0) {
            const top = matches[0];
            const second = matches[1];
            const clearMatch = !second || (top.score - second.score) > 20;
            if (clearMatch) {
                // Strong intent + clear match â†’ navigate directly to L1
                window.location.href = top.href;
                return;
            }
            // Ambiguous â†’ show dropdown (max 5)
            renderSearchResults(matches, query);
            return;
        }

        // 1 keyword or no strong match â†’ show dropdown
        if (matches.length > 0) {
            renderSearchResults(matches, query);
        } else {
            // Fallback: use old scoring
            const result = getBestMarketMatch(query);
            routeToWizardFromQuery(query, finalMode, result ? result.match : null);
        }
        return;
    }

    // â”€â”€ STEP MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const kwCount = countKeywords(query);

    if (kwCount === 1) {
        // 1 keyword: show all matching markets (max 8), user picks
        const matches = getTopMatches(query, 8);
        if (matches.length === 1) {
            // Single unambiguous match â†’ navigate directly to L1
            window.location.href = matches[0].href;
            return;
        }
        renderStepPanel(matches, kwCount);
    } else {
        // 2-3 keywords: try to narrow down
        const matches = getTopMatches(query, 8);
        if (matches.length === 0) {
            renderStepPanel([], kwCount);
            return;
        }
        // Check if top match is clearly dominant (score gap > 20)
        const top = matches[0];
        const second = matches[1];
        const clearMatch = !second || (top.score - second.score) > 20;
        if (clearMatch) {
            // Navigate directly to L1
            window.location.href = top.href;
            return;
        }
        // Ambiguous: show panel with top options (max 5â€“8)
        renderStepPanel(matches.slice(0, 8), kwCount);
    }
}

function renderSearchResults(matches, query) {
    closeStepPanel();
    if (matches.length === 0) {
        searchResults.innerHTML = '<div class="search-no-results">No markets found</div>';
        searchResults.classList.remove('hidden');
        return;
    }

    const kwCount = query ? countKeywords(query) : 1;
    // In auto mode with 2-3 keywords, cap dropdown at 5 (narrower intent)
    const displayMatches = kwCount >= 2 ? matches.slice(0, 5) : matches.slice(0, 8);

    searchResults.innerHTML = '';
    displayMatches.forEach(match => {
        const resultItem = document.createElement('a');
        resultItem.href = match.href;
        resultItem.className = 'search-result-item';
        const badge = match.matchType === 'keyword' ? '<span class="result-badge">keyword match</span>'
                    : match.matchType === 'fallback' ? '<span class="result-badge">best guess</span>'
                    : '';
        resultItem.innerHTML = `<span class="result-name">${match.name}</span>${badge}`;
        searchResults.appendChild(resultItem);
    });

    searchResults.classList.remove('hidden');
}

searchInput.addEventListener('input', (e) => {
    const query = e.target.value;
    if (!query || query.length < 2) {
        searchResults.classList.add('hidden');
        return;
    }
    // Only show dropdown in auto mode while typing
    if (getFlowMode() === 'auto') {
        const matches = searchMarkets(query);
        renderSearchResults(matches, query);
    } else {
        searchResults.classList.add('hidden');
    }
});

        if (btnAutoComplete && btnStepByStep) {
    btnAutoComplete.addEventListener('click', () => setFlowMode('auto'));
    btnStepByStep.addEventListener('click', () => setFlowMode('step'));
    setFlowMode(getFlowMode());
}

searchInput.addEventListener('focus', (e) => {
    const query = e.target.value;
    if (query.length >= 2 && getFlowMode() === 'auto') {
        const matches = searchMarkets(query);
        renderSearchResults(matches, query);
    }
});

        searchInput.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            e.preventDefault();
            runQueryWithMode();
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.add('hidden');
                closeStepPanel();
            }
        });

        // â”€â”€ AI Suggestions (mock-friendly, toggleable) â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function mapQueryToSelections(query) {
            const lower = query.toLowerCase();
            const keywords = [];
            const selections = {};

            // Market guess
            if (lower.includes('online') || lower.includes('ecommerce') || lower.includes('store')) {
                selections.market = 'Retail & E-commerce';
                keywords.push('online');
            } else if (lower.includes('youtube')) {
                selections.market = 'Media & Entertainment';
                keywords.push('youtube');
            } else if (lower.includes('saas')) {
                selections.market = 'Software';
                keywords.push('saas');
            }

            // Mechanics
            selections.mechanics = {
                'Distribution Channels': [],
                'Monetization Models': [],
                'Business Assets': [],
                'Operating Models': []
            };
            if (lower.includes('youtube')) selections.mechanics['Distribution Channels'].push('YouTube');
            if (lower.includes('email')) selections.mechanics['Distribution Channels'].push('Email');
            if (lower.includes('seo') || lower.includes('online')) selections.mechanics['Distribution Channels'].push('SEO');
            if (lower.includes('ads') || lower.includes('paid')) selections.mechanics['Distribution Channels'].push('Paid Ads');
            if (lower.includes('affiliate')) selections.mechanics['Monetization Models'].push('Affiliate');
            if (lower.includes('subscription') || lower.includes('saas')) selections.mechanics['Monetization Models'].push('Subscription');
            if (lower.includes('data')) selections.mechanics['Business Assets'].push('Data');
            if (lower.includes('community')) selections.mechanics['Business Assets'].push('Community');
            if (lower.includes('solo') || lower.includes('creator')) selections.mechanics['Operating Models'].push('Solo Creator');
            if (lower.includes('agency')) selections.mechanics['Operating Models'].push('Agency');
            if (lower.includes('marketplace')) selections.mechanics['Operating Models'].push('Marketplace');

            // Target / Problem / Model / GTM defaults
            selections.target = lower.includes('enterprise') ? 'Enterprise' : (lower.includes('sm') ? 'SMBs' : 'Consumers (Millennials)');
            selections.problem = lower.includes('expensive') ? 'Too expensive' : 'Access / availability';
            selections.severity = lower.includes('critical') ? 'Critical â€” Blocks operations' : 'High â€” Significant daily pain';
            selections.existing_behavior = lower.includes('manual') ? 'Manually (paper, Excel, WhatsApp)' : 'With improvised tools';
            selections.model = selections.mechanics['Monetization Models'][0] || 'Subscription (SaaS)';
            selections.gtm = lower.includes('youtube') ? 'Influencer / Creator' : 'Content Marketing / SEO';
            selections.validation_signal = 'ðŸŸ¡ Medium signal';

            const highlight = [];
            if (keywords.includes('online')) highlight.push('market');
            if (keywords.includes('youtube')) highlight.push('mechanics');

            if (!selections.market) {
    selections.market = 'Advertising & Marketing';
    if (!keywords.includes('marketing')) keywords.push('marketing');
}
return { selections, keywords, highlight };
        }

        function handleAiGenerate(queryOverride) {
            const mode = localStorage.getItem('prefill_mode') || getFlowMode();
            const query = (queryOverride ?? searchInput.value).trim();
            if (!query) {
                alert('Scrivi una frase da interpretare');
                return;
            }

            const markets = MARKET_INDEX.map(m => m.name);
            const options = {
                markets,
                mechanics: {
                    "Distribution Channels": ["YouTube", "Email", "SEO", "Paid Ads", "Influencer Marketing", "Communities"],
                    "Monetization Models": ["Subscription", "Advertising", "Lead Generation", "Affiliate", "One-off Payments"],
                    "Business Assets": ["Audience", "Data", "Software", "Community", "Brand"],
                    "Operating Models": ["Solo Creator", "Agency", "SaaS", "Marketplace", "Media Business"]
                },
                targets: ["SMBs", "Enterprise", "Startups", "Freelancers / Solopreneurs", "Consumers (Gen Z)", "Consumers (Millennials)", "Consumers (Gen X+)", "Developers", "Creators / Influencers", "Students"],
                severities: ["Critical â€” Blocks operations", "High â€” Significant daily pain", "Medium â€” Noticeable friction", "Low â€” Minor inconvenience"],
                behaviors: ["Manually (paper, Excel, WhatsApp)", "With improvised tools", "With an existing product", "Not solved at all", "Outsourced to people"],
                models: ["Subscription (SaaS)", "Marketplace", "Freemium", "Pay-per-use", "Advertising", "Licensing", "Hardware + Software", "Agency / Services"],
                gtms: ["Product-Led Growth", "Content Marketing / SEO", "Outbound Sales", "Partnerships / Channels", "Community-Led", "Paid Acquisition", "Influencer / Creator", "Events / Conferences"]
            };

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), AI_TIMEOUT_MS);

            fetch(AI_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: query, options }),
                signal: controller.signal
            })
            .then(res => {
                if (!res.ok) throw new Error("AI endpoint error");
                return res.json();
            })
            .then(data => {
                clearTimeout(timeout);
                const selections = {
                    market: data.market,
                    problem: data.problem,
                    target: data.target,
                    severity: data.severity,
                    existing_behavior: data.existing_behavior,
                    mechanics: data.mechanics,
                    model: data.model,
                    gtm: data.gtm,
                    validation_signal: "ðŸŸ¡ Medium signal"
                };
                const payload = {
                    prompt: query,
                    selections,
                    keywords: data.keywords || [],
                    highlight: data.highlight || []
                };

                localStorage.setItem('ai_prefill', JSON.stringify(payload));
                localStorage.setItem('prefill_mode', mode);
                if (mode === 'auto') {
                    localStorage.setItem('auto_add_sheet', '1');
                } else {
                    localStorage.removeItem('auto_add_sheet');
                }
                if (selections.market) {
                    localStorage.setItem('selected_market', selections.market);
                }
                window.location.href = 'index.html';
            })
            .catch(() => {
                clearTimeout(timeout);
                const { selections, keywords, highlight } = mapQueryToSelections(query);
                const payload = { prompt: query, selections, keywords, highlight };
                localStorage.setItem('ai_prefill', JSON.stringify(payload));
                localStorage.setItem('prefill_mode', mode);
                if (mode === 'auto') {
                    localStorage.setItem('auto_add_sheet', '1');
                } else {
                    localStorage.removeItem('auto_add_sheet');
                }
                if (selections.market) {
                    localStorage.setItem('selected_market', selections.market);
                }
                alert('AI non disponibile. Uso mapping locale.');
                window.location.href = 'index.html';
            });
        }

        if (promptInput) {
            promptInput.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                const mode = getFlowMode();
                localStorage.setItem('prefill_mode', mode);
                handleAiGenerate(promptInput.value);
            });
        }

        const keywordSearchBtn = document.getElementById('keyword-search-btn');
        if (keywordSearchBtn) {
            keywordSearchBtn.addEventListener('click', () => {
                runQueryWithMode();
            });
        }

        const promptSearchBtn = document.getElementById('prompt-search-btn');
        if (promptSearchBtn) {
            promptSearchBtn.addEventListener('click', () => {
                const mode = getFlowMode();
                localStorage.setItem('prefill_mode', mode);
                handleAiGenerate(promptInput ? promptInput.value : '');
            });
        }
    </script>
    <script src="i18n.js"></script>
</body>
</html>
